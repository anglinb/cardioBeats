<!DOCTYPE html>
<html>
<head>
<title>JogNation</title>

	<!-- <link rel="stylesheet" type="text/css" href="assets/demoStyles.css" /> -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <style>
        /* Sticky footer styles
-------------------------------------------------- */
html {
  position: relative;
  min-height: 100%;
}
body {
  /* Margin bottom by footer height */
  margin-bottom: 60px;

      background: url(assets/img/bg3.jpg) no-repeat center center fixed; 
  -webkit-background-size: cover;
  -moz-background-size: cover;
  -o-background-size: cover;
  background-size: cover;
}
.footer {
  position: absolute;
  bottom: 0;
  width: 100%;
  /* Set the fixed height of the footer here */
  height: 60px;
  background-color: #f5f5f5;
}
    </style>
</head>

<body onload="init()">

    <!-- <h2 style="">BPM: <span id="bpm-status"></span></h2> -->
	<!-- <header id="header" class="SoundJS">
	    <h1><span class="text-product">Jog<strong>Nation</strong></span></h1>
	    <p>Connect your Myo and JobNation will play songs with a bpm that match your pace.</p>

	</header> -->


	<div class="content" id="content">
		<h1 id="status">Startup.</h1>
            <div id="track" style="display: block; width: 500px; height: 5px; background: red;">
                <div id="progress"></div>
                <div id="thumb" style="background: green; width: 5px; height: 5px;"></div>
            </div>
	</div>
	
	<div id="error" style="display: none;">
		<h1>Sorry!</h1>
		<p>SoundJS is not currently supported in your browser.</p>
		<p>Please <a href="http://github.com/CreateJS/SoundJS/issues" target="_blank">log a bug</a>
			with the device and browser you are using.  Thank you.</p>
	</div>

    <div id="mobile" style="display:none;">
        <h1>Sorry!</h1>
        <p>Mobile devices require sound to be played inside of user events, which this demo does not do.</p>
        <p>Please <a href="http://github.com/CreateJS/SoundJS/issues" target="_blank">log a bug</a>
            with the OS and browser if you see this on a device that is not mobile.  Thank you.</p>
    </div>
    
        
    <div class="footer" style="background-color: #222;">
      <div class="container">
        <p style="color: #fff; text-align: center;">Made with <span class="glyphicon glyphicon-heart"></span> by <a href="https://twitter.com/TheBrianAnglin">@theBrianAnglin</a> &amp; <a href="https://twitter.com/micoabrina">@micoabrina</a> <img style="height: 100%;" src="assets/img/footer-logo2.png" alt="Hack SC"></p>
      </div>
    </div>

	<!-- Note: All SoundJS classes are listed here: -->
	<script type="text/javascript" src="../src/createjs/utils/Proxy.js"></script>
	<script type="text/javascript" src="../src/createjs/utils/IndexOf.js"></script>
	<script type="text/javascript" src="../src/createjs/events/Event.js"></script>
	<script type="text/javascript" src="../src/createjs/events/EventDispatcher.js"></script>
    <script type="text/javascript" src="../src/soundjs/Sound.js"></script>
    <script type="text/javascript" src="../src/soundjs/WebAudioPlugin.js"></script>
    <script type="text/javascript" src="../src/soundjs/HTMLAudioPlugin.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

	<!-- We also provide hosted minified versions of all CreateJS libraries.
     http://code.createjs.com -->
	
    <script>
        var src;            // the audio src we are trying to play
        var soundInstance;  // the soundInstance returned by Sound when we create or play a src
        var displayStatus;  // the HTML element we use to display messages to the user
        var socket = io();
        var songMeta = {};
        var lastTime;
        var lastBPMS = [];
        var positionInterval;
        // var timeDelta;


        function init() {
            if (window.top != window) {
                document.getElementById("header").style.display = "none";
            }

            // this does two things, it initializes the default plugins, and if that fails the if statement triggers and we display an error
            if (!createjs.Sound.initializeDefaultPlugins()) {
                document.getElementById("error").style.display = "block";
                document.getElementById("content").style.display = "none";
                return;
            }

            // check if we are on a mobile device, as these currently require us to launch sound inside of a user event
            if (createjs.Sound.BrowserDetect.isIOS || createjs.Sound.BrowserDetect.isAndroid) {  // || createjs.Sound.BrowserDetect.isBlackberry  // OJR blackberry has not been tested yet
                document.getElementById("mobile").style.display = "block";
                document.getElementById("content").style.display = "none";
                return;
            }

            // store the DOM element so we do not have to keep looking it up
            displayStatus = document.getElementById("status");
            BPMStatus = document.getElementById("bpm-status");
        }
        function loadSoundAndPlay(url){
            // Create a single item to load.
            // var assetsPath = "assets/";
            // src = assetsPath+"18-machinae_supremacy-lord_krutors_dominion.ogg";
            src = url;
            // NOTE the "|" character is used by Sound to separate source into distinct files, which allows you to provide multiple extensions for wider browser support

            createjs.Sound.alternateExtensions = ["mp3"];   // add other extensions to try loading if the src file extension is not supported
            //createjs.Sound.onLoadComplete = playSound;  // add a callback for when load is completed
            createjs.Sound.addEventListener("fileload", playSound); // add an event listener for when load is completed
            createjs.Sound.registerSound(src);  // register sound, which preloads by default

            displayStatus.innerHTML = "Waiting for load to complete.";  // letting the user know what's happening
        }
        function playSound(event) {
            if( soundInstance ){
                soundInstance.stop();
            }
			soundInstance = createjs.Sound.play(event.src);  // start playing the sound we just loaded, storing the playing instance
			displayStatus.innerHTML = "Playing source: " + event.src;  // let the user know what we are playing
        }
        function updateBPM(bpm){
            BPMStatus.innerHTML = String(bpm);
        }
        function trackTime() {
            positionInterval = setInterval(function(event) {
                if( soundInstance ){
                    $("#thumb").css("left", soundInstance.getPosition()/soundInstance.getDuration() * $("#track").width());
                }
            }, 30);
        }
        socket.on('bpm update', function(data){
            updateBPM(data.bpm);
        });
        socket.on('play song', function(data){
            songMeta.bpm = data.bpm;
            songMeta.name = data.name;
            songMeta.source = data.source;
            songMeta.cover = data.cover;
            loadSoundAndPlay(data.source);
            updateSongMeta();
        });
        $('body').keyup(function(e){
           if(e.keyCode == 32){
            console.log('Space Pressed');
            if( ! lastTime ){
                lastTime = new Date().getTime();
            }else{
                var bpm;
                var currentTime = new Date().getTime();
                timeDelata = currentTime - lastTime;
                lastTime = currentTime;
                bpm = 60000*(1/timeDelata);
                lastBPMS.push(bpm);
                // console.log(bpm);
                if( lastBPMS.length >= 5){
                    lastBPMS.shift();
                }
                total = 0;
                for (var i = 0; i < lastBPMS.length; i++) {
                    total += lastBPMS[i];
                };
                average = total / lastBPMS.length;
                rounded = x_rounded = 5 * Math.round(average/5);
                console.log(average);
                console.log(rounded);
            }
           }
        });
    </script>


<!-- bpm = beats / 60 seconds = beats / 60000 milieconds 

468 miliseconds / beat

beat / 468 miliseconds 


x/60000 = 1/468 -->
</body>
</html>
